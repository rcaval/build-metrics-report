(function(){"use strict";angular.module("buildMetricsReportApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.grid"]).config(["$routeProvider","$httpProvider",function(a,b){return a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/pivot",{templateUrl:"views/pivot.html",controller:"PivotCtrl",controllerAs:"pivot"}).when("/originaldata",{templateUrl:"views/originaldata.html",controller:"OriginalDataCtrl",controllerAs:"originaldata"}).otherwise({redirectTo:"/"}),b.defaults.headers.common["Access-Control-Allow-Origin"]="*"}]).run(["$rootScope","$location",function(a,b){return a.QueryParams=b.search()}])}).call(this),function(){"use strict";angular.module("buildMetricsReportApp").controller("MainCtrl",["$scope","$http","jenkinsDataService","$q","timelineTransformService",function(a,b,c,d,e){var f,g,h,i,j,k,l;g=$.pivotUtilities.aggregatorTemplates,f=$.pivotUtilities.aggregators,h=$.pivotUtilities.derivers.dateFormat,i=$.pivotUtilities.numberFormat,a.data=c.data,a.jobs=c.jobs,l=d.defer(),a.timelineData=l.promise,a.data.then(function(a){return console.log(a),l.resolve(e.transform(a))}),k=function(b){return"result"===b?$.pivotUtilities.sortAs(["SUCCESS","UNSTABLE","FAILURE","ABORTED"]):"segment"===b?$.pivotUtilities.sortAs(a.jobs):void 0},j=function(b,c){var d,e;return d=_.indexOf(a.jobs,b.id),e=_.indexOf(a.jobs,c.id),d-e},a.weeklyBuildTime={options:{renderer:$.pivotUtilities.c3_renderers["Area Chart"],rows:["segment"],cols:["week"],sorters:k,aggregatorName:"Duration",aggregator:g.average(h("%M:%s"))(["duration"]),rendererOptions:{c3:{size:{height:350,width:700},axis:{y:{tick:{format:function(a){return d3.time.format("%Mm %Ss")(new Date(a))}}},x:{label:""}},grid:{y:{show:!0}},data:{type:"area-step",order:j},tooltip:{grouped:!0}}}}},a.weeklySucessRate={defaultOptions:{renderer:$.pivotUtilities.c3_renderers["Stacked Bar Chart"],rows:["result"],cols:["week"],aggregator:f["Count as Fraction of Columns"](),sorters:k,rendererOptions:{c3:{size:{height:150,width:300},axis:{y:{tick:{format:i({digitsAfterDecimal:1,scaler:100,suffix:"%"})},padding:{top:0}},x:{padding:{left:0}}},grid:{y:{show:!0}},data:{type:"bar",order:null,colors:{SUCCESS:"#109618",FAILURE:"#dc3912",ABORTED:"#333",UNSTABLE:"#ff9900"}},bar:{width:{ratio:1}},tooltip:{grouped:!0},legend:{show:!1}}}}},a.successRateOptionsFor=function(b){return _.assign({},a.weeklySucessRate.defaultOptions,{filter:function(a){return a.segment===b}})},a.weekly7DaysMTTR={options:{renderer:$.pivotUtilities.c3_renderers["Line Chart"],cols:["week"],rows:["segment"],sorters:k,aggregator:f.Maximum(["7 Days MTTR"]),rendererOptions:{c3:{size:{height:350,width:700},axis:{y:{tick:{format:function(a){return d3.time.format("%X")(new Date(2012,0,0,0,0,0,a))}},padding:{bottom:0}},x:{padding:{left:0},type:"timeseries",tick:{format:"%Y-%U"}}},tooltip:{grouped:!0},grid:{y:{show:!0}}}}}},a.weekly7DaysMTTF={options:{renderer:$.pivotUtilities.c3_renderers["Line Chart"],cols:["week"],rows:["segment"],sorters:k,aggregator:f.Maximum(["7 Days MTTF"]),rendererOptions:{c3:{size:{height:350,width:700},axis:{y:{label:"Hours",tick:{format:function(a){return Math.floor(a/36e5)}},padding:{bottom:0}},x:{padding:{left:0},type:"timeseries",tick:{format:"%Y-%U"}}},tooltip:{grouped:!0},grid:{y:{show:!0}}}}}}}])}.call(this),function(){"use strict";var a,b;b=angular.module("buildMetricsReportApp"),a=function(){function a(a,b){this.data=b.data}return a.$inject=["$scope","jenkinsDataService"],a}(),b.controller("PivotCtrl",a)}.call(this),function(){"use strict";angular.module("buildMetricsReportApp").directive("pivotTable",function(){return{scope:{datasource:"=",options:"=",pivotUi:"=",showConfig:"="},link:function(a,b,c){return a.datasource.then(function(c){var d,e;return e=$.extend($.pivotUtilities.renderers,$.pivotUtilities.c3_renderers),d=a.options,d=_.merge({},d,{renderers:e}),a.showConfig&&(d.onRefresh=function(a){var b;return b=JSON.parse(JSON.stringify(a)),delete b.aggregators,delete b.renderers,delete b.derivedAttributes,delete b.rendererOptions,delete b.localeStrings,console.log(JSON.stringify(b,void 0,2))}),a.pivotUi?$(b).pivotUI(c,d):$(b).pivot(c,d)})}}})}.call(this),function(){"use strict";angular.module("buildMetricsReportApp").directive("timeline",function(){return{scope:{datasource:"="},link:function(a,b,c){return a.datasource.then(function(a){var c,d,e;return d=d3.scale.ordinal().range(["green","red","gray","yellow"]).domain(["SUCCESS","FAILURE","ABORTED","UNSTABLE"]),c=d3.timeline().tickFormat({format:d3.time.format("%m/%d"),tickTime:d3.time.hours,tickInterval:24}).stack().colors(d).colorProperty("status").margin({left:160,right:30,top:0,bottom:0}).width(11e3).showAxisCalendarYear().showTimeAxisTick().labelFormat(function(a){return a}),e=d3.select($(b)[0]).append("svg").attr("width",700).datum(a).call(c).select("svg.scrollable > g").attr("transform","translate(-10300,0)")})}}})}.call(this),function(){"use strict";var a,b;b=angular.module("buildMetricsReportApp"),a=function(){function a(a,c,d,e,f){var g,h,i,j,k,l,m,n;h=c.defer(),m=d.search(),m.host&&m.jobNames?(g=m.allBuilds||"builds",i=_(m.jobNames.split(",")).map(_.trim).value(),n=""+m.host+"/job/:jobName/api/json",j="JSONP",k={jsonp:"JSON_CALLBACK",tree:""+g+"[number,id,timestamp,result,duration]"}):(i=["1-compile","2-functional-tests","3-qa-deploy","4-automated-integration"],j="GET",n="data/:jobName.json",k={}),l=_(i).map(function(c,d){return a(n,{jobName:c},{query:{method:j,params:k,isArray:!0,transformResponse:function(a,b){var c;return c=angular.fromJson(a),c.allBuilds||c.builds}}}).query(function(a){var g;return g=_(a).each(function(a,b){return a.segment=c,a.order=d}).each(b).value(),e.calculateAllTimeMTTR(g),e.calculateAllTimeMTTF(g),e.calculate7DaysMTTR(g),e.calculate7DaysMTTF(g),f.appendStateDuration(g),g}).$promise}).value(),c.all(l).then(function(a){return h.resolve(_.flatten(a))}),this.data=h.promise,this.jobs=i}var b;return a.$inject=["$resource","$q","$location","mttrService","stateDurationService"],b=function(a){return a.date=new Date(a.timestamp),a.month=d3.time.format("%Y-%m")(a.date),a.week=d3.time.format("%Y-%U")(a.date),a.day=d3.time.format("%Y-%m-%d")(a.date),a},a}(),b.service("jenkinsDataService",a)}.call(this),function(){"use strict";angular.module("buildMetricsReportApp").controller("OriginalDataCtrl",["$scope","jenkinsDataService",function(a,b){b.data.then(function(b){return a.data=b})}])}.call(this),function(){"use strict";angular.module("buildMetricsReportApp").service("mttrService",function(){var a,b;return b=function(a,b,c){var d,e,f;return d=0,e=0,f=0,_(a).sortBy("timestamp").each(function(a){if(a[b]=0,a.result!==c){if(0!==d)return;return void(d=a.timestamp)}return 0!==d?(e++,f+=a.timestamp-d,a[b]=0===f?0:f/e,d=0):void 0}).value()},a=function(a,c,d,e){return _(a).sortBy("timestamp").reverse().each(function(f){var g,h;return h=new Date(f.timestamp),h.setDate(h.getDate()-c),g=_.filter(a,function(a){var b;return h.getTime()<=(b=a.timestamp)&&b<=f.timestamp}),b(g,d,e)}).value()},{calculate7DaysMTTR:function(b){return a(b,7,"7 Days MTTR","SUCCESS")},calculate7DaysMTTF:function(b){return a(b,7,"7 Days MTTF","FAILURE")},calculateAllTimeMTTR:function(a){return b(a,"allTimeMTTR","SUCCESS")},calculateAllTimeMTTF:function(a){return b(a,"allTimeMTTF","FAILURE")}}})}.call(this),function(){"use strict";angular.module("buildMetricsReportApp").service("stateDurationService",function(){return{appendStateDuration:function(a){var b;return b=(new Date).getTime(),_(a).sortBy("timestamp").reverse().each(function(a){return a.stateDuration=b-a.timestamp,b=a.timestamp}).value()}}})}.call(this),function(){"use strict";angular.module("buildMetricsReportApp").service("timelineTransformService",function(){return{transform:function(a){var b;return b=function(a){return _(a).map(function(a){return{starting_time:a.timestamp,ending_time:a.timestamp+a.stateDuration,status:a.result}}).value()},_(a).groupBy("segment").map(function(a,c){return{label:c,times:b(a)}}).value()}}})}.call(this),function(){"use strict";angular.module("buildMetricsReportApp").controller("RefreshCtrl",["$scope","$location","$window",function(a,b,c){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"],a.go=function(){return b.search(a.QueryParams),c.location.reload()}}])}.call(this),function(){"use strict";angular.module("buildMetricsReportApp").filter("queryParams",function(){return function(a){var b,c;c=[];for(b in a)b=b,a.hasOwnProperty(b)&&""!==a[b]&&void 0!==a[b]&&c.push(b+"="+a[b]);return c.length?"?"+c.join("&"):""}})}.call(this),angular.module("buildMetricsReportApp").run(["$templateCache",function(a){"use strict";a.put("views/main.html",'<div class="row"> <div class="panel panel-default"> <div class="panel-heading">Job Heat map</div> <div class="panel-body chart" timeline datasource="timelineData"></div> </div> <div class="panel panel-default"> <div class="panel-heading">Mean Time To Recover (MTTR), last 7 days, Weekly Trend <br><small>Once the build is red, how long does it take for the status to go back to green? Zero means it was never red that week, or it was always red that week. "Last 7 days" means it is like a moving average accounting only for builds in the last 7 days.</small> </div> <div class="panel-body chart" pivot-table datasource="data" options="weekly7DaysMTTR.options" pivot-ui="false"> </div> </div> <div class="panel panel-default"> <div class="panel-heading">Build Time <br><small>Y-axis: time in minutes, X-axis: week of year</small></div> <div class="panel-body chart" pivot-table datasource="data" options="weeklyBuildTime.options" pivot-ui="false"></div> </div> <div class="panel panel-default"> <div class="panel-heading">Build Success Rate <br><small>Y-axis:# of builds per status over total builds, X-axis: week of year</small></div> <div class="panel-body"> <div></div> <div class="col-md-6" ng-repeat="job in jobs"> <div class="panel panel-default"> <div class="panel-heading">{{job}} weekly</div> <div class="panel-body chart" pivot-table datasource="data" options="successRateOptionsFor(job)" pivot-ui="false"></div> </div> </div> </div> </div> <div class="panel panel-default"> <div class="panel-heading">Mean Time To Failure (MTTF), last 7 days, Weekly Trend <br><small>Similar to MTTR: Once the build is green, how long does it take for the status to go to red? Like that "X days without accidents" sign. Zero means it was never green that week, or it was always green that week. "Last 7 days" means it is like a moving average accounting only for builds in the last 7 days.</small> </div> <div class="panel-body chart" pivot-table datasource="data" options="weekly7DaysMTTF.options" pivot-ui="false"></div> </div> </div>'),a.put("views/originaldata.html",'<div ui-grid="{data: data}" class="grid"> </div>'),a.put("views/pivot.html",'<section ng-controller="PivotCtrl as ctrl"> <div datasource="ctrl.data" pivot-table="{rows: [], cols: [], vals: [], rendererName: \'Table\'}" pivot-ui="true" show-config="true"></div> </section>')}]);